{"version":"tree-0.1","tree":{"id":"App","path":"","constructInfo":{"fqn":"aws-cdk-lib.App","version":"2.233.0"},"children":{"OpcuaBackendStack":{"id":"OpcuaBackendStack","path":"OpcuaBackendStack","constructInfo":{"fqn":"aws-cdk-lib.Stack","version":"2.233.0"},"children":{"OpcuaVPC":{"id":"OpcuaVPC","path":"OpcuaBackendStack/OpcuaVPC","constructInfo":{"fqn":"aws-cdk-lib.aws_ec2.Vpc","version":"2.233.0","metadata":[]},"children":{"Resource":{"id":"Resource","path":"OpcuaBackendStack/OpcuaVPC/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_ec2.CfnVPC","version":"2.233.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::EC2::VPC","aws:cdk:cloudformation:props":{"cidrBlock":"10.0.0.0/16","enableDnsHostnames":true,"enableDnsSupport":true,"instanceTenancy":"default","tags":[{"key":"Name","value":"OpcuaBackendStack/OpcuaVPC"}]}}},"PublicSubnet1":{"id":"PublicSubnet1","path":"OpcuaBackendStack/OpcuaVPC/PublicSubnet1","constructInfo":{"fqn":"aws-cdk-lib.aws_ec2.PublicSubnet","version":"2.233.0","metadata":[]},"children":{"Subnet":{"id":"Subnet","path":"OpcuaBackendStack/OpcuaVPC/PublicSubnet1/Subnet","constructInfo":{"fqn":"aws-cdk-lib.aws_ec2.CfnSubnet","version":"2.233.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::EC2::Subnet","aws:cdk:cloudformation:props":{"availabilityZone":"us-east-1a","cidrBlock":"10.0.0.0/24","mapPublicIpOnLaunch":true,"tags":[{"key":"aws-cdk:subnet-name","value":"Public"},{"key":"aws-cdk:subnet-type","value":"Public"},{"key":"Name","value":"OpcuaBackendStack/OpcuaVPC/PublicSubnet1"}],"vpcId":{"Ref":"OpcuaVPC67DDCD31"}}}},"Acl":{"id":"Acl","path":"OpcuaBackendStack/OpcuaVPC/PublicSubnet1/Acl","constructInfo":{"fqn":"aws-cdk-lib.Resource","version":"2.233.0","metadata":[]}},"RouteTable":{"id":"RouteTable","path":"OpcuaBackendStack/OpcuaVPC/PublicSubnet1/RouteTable","constructInfo":{"fqn":"aws-cdk-lib.aws_ec2.CfnRouteTable","version":"2.233.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::EC2::RouteTable","aws:cdk:cloudformation:props":{"tags":[{"key":"Name","value":"OpcuaBackendStack/OpcuaVPC/PublicSubnet1"}],"vpcId":{"Ref":"OpcuaVPC67DDCD31"}}}},"RouteTableAssociation":{"id":"RouteTableAssociation","path":"OpcuaBackendStack/OpcuaVPC/PublicSubnet1/RouteTableAssociation","constructInfo":{"fqn":"aws-cdk-lib.aws_ec2.CfnSubnetRouteTableAssociation","version":"2.233.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::EC2::SubnetRouteTableAssociation","aws:cdk:cloudformation:props":{"routeTableId":{"Ref":"OpcuaVPCPublicSubnet1RouteTableF1383496"},"subnetId":{"Ref":"OpcuaVPCPublicSubnet1SubnetDEAACB55"}}}},"DefaultRoute":{"id":"DefaultRoute","path":"OpcuaBackendStack/OpcuaVPC/PublicSubnet1/DefaultRoute","constructInfo":{"fqn":"aws-cdk-lib.aws_ec2.CfnRoute","version":"2.233.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::EC2::Route","aws:cdk:cloudformation:props":{"destinationCidrBlock":"0.0.0.0/0","gatewayId":{"Ref":"OpcuaVPCIGW6C7CA301"},"routeTableId":{"Ref":"OpcuaVPCPublicSubnet1RouteTableF1383496"}}}}}},"IGW":{"id":"IGW","path":"OpcuaBackendStack/OpcuaVPC/IGW","constructInfo":{"fqn":"aws-cdk-lib.aws_ec2.CfnInternetGateway","version":"2.233.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::EC2::InternetGateway","aws:cdk:cloudformation:props":{"tags":[{"key":"Name","value":"OpcuaBackendStack/OpcuaVPC"}]}}},"VPCGW":{"id":"VPCGW","path":"OpcuaBackendStack/OpcuaVPC/VPCGW","constructInfo":{"fqn":"aws-cdk-lib.aws_ec2.CfnVPCGatewayAttachment","version":"2.233.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::EC2::VPCGatewayAttachment","aws:cdk:cloudformation:props":{"internetGatewayId":{"Ref":"OpcuaVPCIGW6C7CA301"},"vpcId":{"Ref":"OpcuaVPC67DDCD31"}}}},"RestrictDefaultSecurityGroupCustomResource":{"id":"RestrictDefaultSecurityGroupCustomResource","path":"OpcuaBackendStack/OpcuaVPC/RestrictDefaultSecurityGroupCustomResource","constructInfo":{"fqn":"aws-cdk-lib.CustomResource","version":"2.233.0","metadata":[]},"children":{"Default":{"id":"Default","path":"OpcuaBackendStack/OpcuaVPC/RestrictDefaultSecurityGroupCustomResource/Default","constructInfo":{"fqn":"aws-cdk-lib.CfnResource","version":"2.233.0"}}}}}},"Custom::VpcRestrictDefaultSGCustomResourceProvider":{"id":"Custom::VpcRestrictDefaultSGCustomResourceProvider","path":"OpcuaBackendStack/Custom::VpcRestrictDefaultSGCustomResourceProvider","constructInfo":{"fqn":"aws-cdk-lib.CustomResourceProviderBase","version":"2.233.0"},"children":{"Staging":{"id":"Staging","path":"OpcuaBackendStack/Custom::VpcRestrictDefaultSGCustomResourceProvider/Staging","constructInfo":{"fqn":"aws-cdk-lib.AssetStaging","version":"2.233.0"}},"Role":{"id":"Role","path":"OpcuaBackendStack/Custom::VpcRestrictDefaultSGCustomResourceProvider/Role","constructInfo":{"fqn":"aws-cdk-lib.CfnResource","version":"2.233.0"}},"Handler":{"id":"Handler","path":"OpcuaBackendStack/Custom::VpcRestrictDefaultSGCustomResourceProvider/Handler","constructInfo":{"fqn":"aws-cdk-lib.CfnResource","version":"2.233.0"}}}},"OpcuaSecurityGroup":{"id":"OpcuaSecurityGroup","path":"OpcuaBackendStack/OpcuaSecurityGroup","constructInfo":{"fqn":"aws-cdk-lib.aws_ec2.SecurityGroup","version":"2.233.0","metadata":[]},"children":{"Resource":{"id":"Resource","path":"OpcuaBackendStack/OpcuaSecurityGroup/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_ec2.CfnSecurityGroup","version":"2.233.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::EC2::SecurityGroup","aws:cdk:cloudformation:props":{"groupDescription":"Security group for OPCUA backend","securityGroupEgress":[{"cidrIp":"0.0.0.0/0","description":"Allow all outbound traffic by default","ipProtocol":"-1"}],"securityGroupIngress":[{"cidrIp":"0.0.0.0/0","ipProtocol":"tcp","fromPort":80,"toPort":80,"description":"Allow HTTP"},{"cidrIp":"0.0.0.0/0","ipProtocol":"tcp","fromPort":443,"toPort":443,"description":"Allow HTTPS"},{"cidrIp":"0.0.0.0/0","ipProtocol":"tcp","fromPort":3000,"toPort":3000,"description":"Allow Backend API"},{"cidrIp":"0.0.0.0/0","ipProtocol":"tcp","fromPort":1883,"toPort":1883,"description":"Allow MQTT"},{"cidrIp":"0.0.0.0/0","ipProtocol":"tcp","fromPort":22,"toPort":22,"description":"Allow SSH - UPDATE TO YOUR IP!"}],"vpcId":{"Ref":"OpcuaVPC67DDCD31"}}}}}},"OpcuaInstanceRole":{"id":"OpcuaInstanceRole","path":"OpcuaBackendStack/OpcuaInstanceRole","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.Role","version":"2.233.0","metadata":[]},"children":{"ImportOpcuaInstanceRole":{"id":"ImportOpcuaInstanceRole","path":"OpcuaBackendStack/OpcuaInstanceRole/ImportOpcuaInstanceRole","constructInfo":{"fqn":"aws-cdk-lib.Resource","version":"2.233.0","metadata":[]}},"Resource":{"id":"Resource","path":"OpcuaBackendStack/OpcuaInstanceRole/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.CfnRole","version":"2.233.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::Role","aws:cdk:cloudformation:props":{"assumeRolePolicyDocument":{"Statement":[{"Action":"sts:AssumeRole","Effect":"Allow","Principal":{"Service":"ec2.amazonaws.com"}}],"Version":"2012-10-17"},"managedPolicyArns":[{"Fn::Join":["",["arn:",{"Ref":"AWS::Partition"},":iam::aws:policy/CloudWatchAgentServerPolicy"]]},{"Fn::Join":["",["arn:",{"Ref":"AWS::Partition"},":iam::aws:policy/AmazonSSMManagedInstanceCore"]]}]}}}}},"OpcuaInstance":{"id":"OpcuaInstance","path":"OpcuaBackendStack/OpcuaInstance","constructInfo":{"fqn":"aws-cdk-lib.aws_ec2.Instance","version":"2.233.0","metadata":[]},"children":{"InstanceProfile":{"id":"InstanceProfile","path":"OpcuaBackendStack/OpcuaInstance/InstanceProfile","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.CfnInstanceProfile","version":"2.233.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::InstanceProfile","aws:cdk:cloudformation:props":{"roles":[{"Ref":"OpcuaInstanceRoleC27EF276"}]}}},"Resource":{"id":"Resource","path":"OpcuaBackendStack/OpcuaInstance/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_ec2.CfnInstance","version":"2.233.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::EC2::Instance","aws:cdk:cloudformation:props":{"availabilityZone":"us-east-1a","blockDeviceMappings":[{"deviceName":"/dev/xvda","ebs":{"deleteOnTermination":true,"volumeSize":50,"volumeType":"gp3"}}],"iamInstanceProfile":{"Ref":"OpcuaInstanceInstanceProfile09FC6AC3"},"imageId":{"Ref":"SsmParameterValueawsserviceamiamazonlinuxlatestal2023amikernel61x8664C96584B6F00A464EAD1953AFF4B05118Parameter"},"instanceType":"t3.medium","securityGroupIds":[{"Fn::GetAtt":["OpcuaSecurityGroupF576D462","GroupId"]}],"subnetId":{"Ref":"OpcuaVPCPublicSubnet1SubnetDEAACB55"},"tags":[{"key":"Name","value":"OPCUA Backend"}],"userData":{"Fn::Base64":"#!/bin/bash\n#!/bin/bash\nset -e\nexec > >(tee /var/log/user-data.log)\nexec 2>&1\n\necho \"=== Starting OPCUA Backend Setup ===\"\necho \"Timestamp: $(date)\"\n\n# Update system\necho \"Updating system packages...\"\nyum update -y\n\n# Install Docker\necho \"Installing Docker...\"\nyum install -y docker git\nsystemctl start docker\nsystemctl enable docker\nusermod -aG docker ec2-user\n\n# Install Docker Compose\necho \"Installing Docker Compose...\"\ncurl -L \"https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-$(uname -s)-$(uname -m)\" -o /usr/local/bin/docker-compose\nchmod +x /usr/local/bin/docker-compose\nln -sf /usr/local/bin/docker-compose /usr/bin/docker-compose\n\n# Verify installations\necho \"Docker version: $(docker --version)\"\necho \"Docker Compose version: $(docker-compose --version)\"\n\n# Clone repository\necho \"Cloning repository...\"\ncd /opt\ngit clone https://github.com/tutuCH/opcua-backend.git opcua-backend || {\n  echo \"ERROR: Failed to clone repository. Please update the repository URL in the CDK stack.\"\n  echo \"Edit infrastructure/lib/opcua-backend-stack.ts and update the git clone URL.\"\n  exit 1\n}\ncd opcua-backend\n\n# Setup environment files\necho \"Setting up environment files...\"\nif [ -f .env.compose.example ]; then\n  cp .env.compose.example .env.compose\nelif [ -f .env.compose.template ]; then\n  cp .env.compose.template .env.compose\nelse\n  echo \"ERROR: No .env.compose template found\"\n  exit 1\nfi\n\nif [ -f .env.local.example ]; then\n  cp .env.local.example .env.local\nfi\n\n# Generate secure secrets\necho \"Generating secure secrets...\"\nJWT_SECRET=$(openssl rand -base64 48)\nPOSTGRES_PASSWORD=$(openssl rand -base64 24)\nREDIS_PASSWORD=$(openssl rand -base64 24)\nINFLUXDB_PASSWORD=$(openssl rand -base64 24)\nINFLUXDB_TOKEN=$(openssl rand -base64 48)\n\n# Update .env.compose with generated secrets\necho \"Updating environment variables...\"\nsed -i \"s|JWT_SECRET=.*|JWT_SECRET=$JWT_SECRET|\" .env.compose\nsed -i \"s|POSTGRES_PASSWORD=.*|POSTGRES_PASSWORD=$POSTGRES_PASSWORD|\" .env.compose\nsed -i \"s|REDIS_PASSWORD=.*|REDIS_PASSWORD=$REDIS_PASSWORD|\" .env.compose\nsed -i \"s|INFLUXDB_PASSWORD=.*|INFLUXDB_PASSWORD=$INFLUXDB_PASSWORD|\" .env.compose\nsed -i \"s|INFLUXDB_TOKEN=.*|INFLUXDB_TOKEN=$INFLUXDB_TOKEN|\" .env.compose\nsed -i \"s|FRONTEND_URL=.*|FRONTEND_URL=https://dashboard.harrytu.cv|\" .env.compose\n\n# Update InfluxDB retention to 30 days\necho \"Configuring InfluxDB retention to 30 days...\"\nsed -i \"s|DOCKER_INFLUXDB_INIT_RETENTION:.*|DOCKER_INFLUXDB_INIT_RETENTION: 720h|\" docker-compose.yml\n\n# Start services\necho \"Starting Docker Compose services...\"\ndocker-compose up -d\n\n# Wait for services to be healthy\necho \"Waiting for services to initialize...\"\nsleep 30\n\n# Check service status\necho \"Service status:\"\ndocker-compose ps\n\n# Create systemd service for auto-restart\necho \"Creating systemd service...\"\ncat > /etc/systemd/system/opcua-backend.service <<EOF\n[Unit]\nDescription=OPCUA Backend Docker Compose\nAfter=docker.service\nRequires=docker.service\n\n[Service]\nType=oneshot\nRemainAfterExit=yes\nWorkingDirectory=/opt/opcua-backend\nExecStart=/usr/local/bin/docker-compose up -d\nExecStop=/usr/local/bin/docker-compose down\n\n[Install]\nWantedBy=multi-user.target\nEOF\n\nsystemctl daemon-reload\nsystemctl enable opcua-backend\n\necho \"=== OPCUA Backend Setup Complete ===\"\necho \"Timestamp: $(date)\"\necho \"Check service status: docker-compose ps\"\necho \"View logs: docker-compose logs -f\""}}}}}},"SsmParameterValue:--aws--service--ami-amazon-linux-latest--al2023-ami-kernel-6.1-x86_64:C96584B6-F00A-464E-AD19-53AFF4B05118.Parameter":{"id":"SsmParameterValue:--aws--service--ami-amazon-linux-latest--al2023-ami-kernel-6.1-x86_64:C96584B6-F00A-464E-AD19-53AFF4B05118.Parameter","path":"OpcuaBackendStack/SsmParameterValue:--aws--service--ami-amazon-linux-latest--al2023-ami-kernel-6.1-x86_64:C96584B6-F00A-464E-AD19-53AFF4B05118.Parameter","constructInfo":{"fqn":"aws-cdk-lib.CfnParameter","version":"2.233.0"}},"SsmParameterValue:--aws--service--ami-amazon-linux-latest--al2023-ami-kernel-6.1-x86_64:C96584B6-F00A-464E-AD19-53AFF4B05118":{"id":"SsmParameterValue:--aws--service--ami-amazon-linux-latest--al2023-ami-kernel-6.1-x86_64:C96584B6-F00A-464E-AD19-53AFF4B05118","path":"OpcuaBackendStack/SsmParameterValue:--aws--service--ami-amazon-linux-latest--al2023-ami-kernel-6.1-x86_64:C96584B6-F00A-464E-AD19-53AFF4B05118","constructInfo":{"fqn":"aws-cdk-lib.Resource","version":"2.233.0","metadata":[]}},"OpcuaElasticIP":{"id":"OpcuaElasticIP","path":"OpcuaBackendStack/OpcuaElasticIP","constructInfo":{"fqn":"aws-cdk-lib.aws_ec2.CfnEIP","version":"2.233.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::EC2::EIP","aws:cdk:cloudformation:props":{"domain":"vpc","tags":[{"key":"Name","value":"OPCUA Backend Static IP"}]}}},"EIPAssociation":{"id":"EIPAssociation","path":"OpcuaBackendStack/EIPAssociation","constructInfo":{"fqn":"aws-cdk-lib.aws_ec2.CfnEIPAssociation","version":"2.233.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::EC2::EIPAssociation","aws:cdk:cloudformation:props":{"eip":{"Ref":"OpcuaElasticIP"},"instanceId":{"Ref":"OpcuaInstance5E3C8E76"}}}},"ElasticIP":{"id":"ElasticIP","path":"OpcuaBackendStack/ElasticIP","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.233.0"}},"InstanceId":{"id":"InstanceId","path":"OpcuaBackendStack/InstanceId","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.233.0"}},"BackendURL":{"id":"BackendURL","path":"OpcuaBackendStack/BackendURL","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.233.0"}},"HealthCheckURL":{"id":"HealthCheckURL","path":"OpcuaBackendStack/HealthCheckURL","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.233.0"}},"MQTTBroker":{"id":"MQTTBroker","path":"OpcuaBackendStack/MQTTBroker","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.233.0"}},"WebSocketURL":{"id":"WebSocketURL","path":"OpcuaBackendStack/WebSocketURL","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.233.0"}},"SSHCommand":{"id":"SSHCommand","path":"OpcuaBackendStack/SSHCommand","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.233.0"}},"InstanceType":{"id":"InstanceType","path":"OpcuaBackendStack/InstanceType","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.233.0"}},"StorageSize":{"id":"StorageSize","path":"OpcuaBackendStack/StorageSize","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.233.0"}},"CDKMetadata":{"id":"CDKMetadata","path":"OpcuaBackendStack/CDKMetadata","constructInfo":{"fqn":"constructs.Construct","version":"10.4.4"},"children":{"Default":{"id":"Default","path":"OpcuaBackendStack/CDKMetadata/Default","constructInfo":{"fqn":"aws-cdk-lib.CfnResource","version":"2.233.0"}}}},"BootstrapVersion":{"id":"BootstrapVersion","path":"OpcuaBackendStack/BootstrapVersion","constructInfo":{"fqn":"aws-cdk-lib.CfnParameter","version":"2.233.0"}},"CheckBootstrapVersion":{"id":"CheckBootstrapVersion","path":"OpcuaBackendStack/CheckBootstrapVersion","constructInfo":{"fqn":"aws-cdk-lib.CfnRule","version":"2.233.0"}}}},"Tree":{"id":"Tree","path":"Tree","constructInfo":{"fqn":"constructs.Construct","version":"10.4.4"}}}}}